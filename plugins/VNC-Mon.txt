#!/bin/bash

declare -A verbindungen=(
  ["VNC01"]="192.168.50.35"
  ["VNC02"]="192.168.255.10"
)

declare -A counter=()

# Initialisiere alle Counter auf 0
for name in "${!verbindungen[@]}"; do
  counter[$name]=0
done

while true; do
  #Prüfe ob ein Fehlerfenster offen ist
  error_ids=$(wmctrl -l | grep "VNC Viewer: Information" | awk '{print $1}')

  #Schließen des Fensters
  if [ "$error_ids" ]; then
    for id in $error_ids; do
      wmctrl -i -c $id
    done
    sleep 5
  fi

  # Für alle Verbindungen
  for name in "${!verbindungen[@]}"; do
    ip=${verbindungen[$name]}

    # Prüfe ob die Verbindung mit dem Namen läuft
    fenster_ids=$(wmctrl -l | grep "$name" | awk '{print $1}')
    if ! [ -z "$fenster_ids" ]; then
      # Führe Ping aus
      ping -c 1 -w 1 $ip >/dev/null

      if [ $? -eq 0 ]; then
        # Wenn der Ping erfolgreich ist, setze den Counter auf 0
        counter[$name]=0
      else
        # Wenn der Ping fehlschlägt, erhöhe den Counter
        ((counter[$name]++))

        # Wenn der Counter 5 erreicht, beende die Verbindung
        if [ ${counter[$name]} -eq 5 ]; then
          notify-send "$ip nicht erreichbar. Beende Verbindung $name"

          fenster_ids=$(wmctrl -l | grep "$name" | awk '{print $1}')

          # Schließen des Fensters
          for id in $fenster_ids; do
            wmctrl -i -c $id
          done

          counter[$name]=0
        fi
      fi
    fi
  done
  # Warte eine Sekunde
  sleep 1
done
